 <%= form_with model: [:admin, coupon], local: true do |f| %>
   <div class="coupon-form">
     <% if coupon.errors.any? %>
       <div class="alert alert-danger">
         <h2><%= pluralize(coupon.errors.count, "error") %> prohibited this coupon from being saved:</h2>
         <ul>
           <% coupon.errors.full_messages.each do |message| %>
             <li><%= message %></li>
           <% end %>
         </ul>
       </div>
     <% end %>

     <details open>
       <summary>Basic Information</summary>

       <div class="form-group">
         <%= f.label :code %>
         <%= f.text_field :code, required: true, autofocus: true %>
         <small class="form-text">Unique coupon code that customers will enter</small>
       </div>

       <div class="form-group">
         <%= f.label :description %>
         <%= f.text_area :description, rows: 3 %>
         <small class="form-text">Internal description for admin reference</small>
       </div>

       <div class="form-group">
         <%= f.label :state %>
         <%= f.select :state,
             options_for_select(Coupon.states.keys.map { |s| [s.humanize, s] }, coupon.state) %>
       </div>
     </details>

     <details>
       <summary>Discount Configuration</summary>

       <div class="form-group">
         <%= f.label :discount_type %>
         <%= f.select :discount_type,
             options_for_select(Coupon.discount_types.keys.map { |dt|
               case dt
               when "fixed_cart"
                 ["Fixed Cart Discount", "fixed_cart"]
               when "percent_cart"
                 ["Percentage Cart Discount", "percent_cart"]
               when "fixed_product"
                 ["Fixed Product Discount", "fixed_product"]
               when "percent_product"
                 ["Percentage Product Discount", "percent_product"]
               when "free_shipping"
                 ["Free Shipping", "free_shipping"]
               end
             }, coupon.discount_type) %>
         <small class="form-text">
           Choose how to discount is applied
         </small>
       </div>

       <div class="form-group" id="discount-amount-group">
         <%= f.label :discount_amount %>
         <%= f.number_field :discount_amount, min: 0, step: 0.01 %>
         <small class="form-text">
           Amount in <%= Current.settings["currency"] || "IDR" %>. For percentage, enter value (e.g., 10 for 10%)
         </small>
       </div>
     </details>

     <details>
       <summary>Usage Restrictions</summary>

       <div class="form-group">
         <%= f.label :minimum_amount %>
         <%= f.number_field :minimum_amount, min: 0, step: 0.01 %>
         <small class="form-text">Minimum cart subtotal required (in <%= Current.settings["currency"] || "IDR" %>)</small>
       </div>

       <div class="form-group">
         <%= f.label :maximum_amount %>
         <%= f.number_field :maximum_amount, min: 0, step: 0.01 %>
         <small class="form-text">Maximum cart subtotal allowed (in <%= Current.settings["currency"] || "IDR" %>)</small>
       </div>

       <div class="form-group">
         <%= f.label :usage_limit %>
         <%= f.number_field :usage_limit, min: 0 %>
         <small class="form-text">Maximum times this coupon can be used total (0 for unlimited)</small>
       </div>

       <div class="form-group">
         <%= f.label :usage_limit_per_user %>
         <%= f.number_field :usage_limit_per_user, min: 0 %>
         <small class="form-text">Maximum times each customer can use this coupon (0 for unlimited)</small>
       </div>
     </details>

     <details>
       <summary>Date Restrictions</summary>

       <div class="form-group">
         <%= f.label :starts_at %>
         <%= f.datetime_field :starts_at %>
         <small class="form-text">When coupon becomes valid (leave blank for immediate)</small>
       </div>

       <div class="form-group">
         <%= f.label :expires_at %>
         <%= f.datetime_field :expires_at %>
         <small class="form-text">When coupon expires (leave blank for never)</small>
       </div>
     </details>

     <details>
       <summary>Additional Options</summary>

       <div class="form-group checkbox">
         <%= f.check_box :exclude_sale_items %>
         <%= f.label :exclude_sale_items, "Exclude sale items from discount" %>
       </div>
     </details>

     <details>
       <summary>Product Restrictions</summary>

       <p class="form-text">Restrict which products this coupon applies to</p>

       <div class="form-group mb-4">
         <label>Include Products</label>
         <article class="mb-1">
           <%= f.collection_check_boxes :included_product_ids, products, :id, :name do |b| %>
             <%= b.label class: "flex" do %>
               <%= b.check_box class: "flex-noshrink", style: "margin-top: 2px" %>
               <%= b.object.name %>
             <% end %>
           <% end %>
         </article>
         <small class="text-gray">Coupon will only apply to these products (leave blank to apply to all)</small>
       </div>

       <div class="form-group">
         <label>Exclude Products</label>
         <article class="mb-1">
           <%= f.collection_check_boxes :excluded_product_ids, products, :id, :name do |b| %>
             <%= b.label class: "flex" do %>
               <%= b.check_box class: "flex-noshrink", style: "margin-top: 2px" %>
               <%= b.object.name %>
             <% end %>
           <% end %>
         </article>
         <small class="text-gray">Coupon will NOT apply to these products</small>
       </div>
     </details>

     <details>
       <summary>Category Restrictions</summary>
       <p class="form-text">Restrict which categories this coupon applies to</p>

       <div class="form-group">
         <label>Include Categories</label>
         <article class="mb-1">
           <%= f.collection_check_boxes :included_category_ids, categories, :id, :name do |b| %>
             <%= b.label class: "flex" do %>
               <%= b.check_box class: "flex-noshrink", style: "margin-top: 2px" %>
               <%= b.object.name %>
             <% end %>
           <% end %>
         </article>
         <small class="text-gray">Coupon will only apply to products in these categories (leave blank to apply to all)</small>
       </div>

       <div class="form-group">
         <label>Exclude Categories</label>
         <article class="mb-1">
           <%= f.collection_check_boxes :excluded_category_ids, categories, :id, :name do |b| %>
             <%= b.label class: "flex" do %>
               <%= b.check_box class: "flex-noshrink", style: "margin-top: 2px" %>
               <%= b.object.name %>
             <% end %>
           <% end %>
         </article>
         <small class="text-gray">Coupon will NOT apply to products in these categories</small>
       </div>
     </details>

     <div class="form-actions">
       <%= f.submit "Save Coupon", class: "btn btn-primary" %>
       <%= link_to "Cancel", admin_coupons_path, class: "btn btn-secondary" %>
     </div>
   </div>

   <script>
     document.addEventListener('DOMContentLoaded', function() {
       const discountTypeSelect = document.querySelector('#coupon_discount_type');
       const discountAmountGroup = document.querySelector('#discount-amount-group');

       function toggleDiscountAmount() {
         const discountType = discountTypeSelect.value;
         if (discountType === 'free_shipping') {
           discountAmountGroup.style.display = 'none';
         } else {
           discountAmountGroup.style.display = 'block';
         }
       }

       discountTypeSelect.addEventListener('change', toggleDiscountAmount);
       toggleDiscountAmount();
     });
   </script>
 <% end %>
