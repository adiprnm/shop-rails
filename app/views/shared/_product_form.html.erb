<%= form_for [:admin, product], html: { class: "form-layout" } do |f| %>
  <div>
    <div class="form-group" data-controller="image-preview">
      <%= f.label :featured_image %>
      <%= image_tag product.featured_image.attached? ? product.featured_image : "", data: { image_preview_target: "preview" } %>
      <%= f.file_field :featured_image, data: { action: "image-preview#perform" } %>
    </div>
    <div class="form-group">
      <%= f.label :images %>
      <%= f.file_field :images, multiple: true, accept: "image/*" %>
      <small class="block">Upload multiple images for the product carousel (optional)</small>
      <% if product.images.attached? %>
        <div class="mt-2">
          <% product.images.each do |image| %>
            <div class="mb-2 flex items-center gap-2">
              <%= image_tag image, class: "product-image product-image--small" %>
              <%= button_to "Remove", delete_image_admin_product_path(product, image_id: image.id), method: :delete, data: { turbo_confirm: "Are you sure?" }, form: { class: "inline" }, class: "text-red text-sm button-as-text" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <div>
    <div class="form-group">
      <%= f.label :name %>
      <%= f.text_field :name, required: true %>
    </div>
    <div class="form-group">
      <%= f.label :slug %>
      <%= f.text_field :slug, required: true %>
    </div>
    <div class="form-group">
      <%= f.label :short_description %>
      <%= f.text_field :short_description, required: true %>
    </div>
    <div class="form-group">
      <%= f.label :description %>
      <%= f.text_area :description, style: "min-height: 300px" %>
    </div>
    <div class="form-group check-boxes">
      <%= f.label :category_ids, "Category" %>
      <%= f.collection_check_boxes :category_ids, Category.all, :id, :name do |b| %>
        <%= b.label do %>
          <%= b.check_box %>
          <%= b.object.name %>
        <% end %>
      <% end %>
    </div>
    <div class="form-group">
      <%= f.label :price %>
      <%= f.number_field :price, required: true %>
    </div>
    <div class="form-group">
      <%= f.label :sale_price %>
      <%= f.number_field :sale_price %>
    </div>
    <div class="form-group">
      <%= f.label :minimum_price %>
      <%= f.number_field :minimum_price %>
      <small>Menggunakan harga minimal akan mengabaikan harga asli dan harga diskon</small>
    </div>
    <div class="grouped">
      <div class="form-group">
        <%= f.label :sale_price_starts_at %>
        <%= f.date_field :sale_price_starts_at %>
      </div>
      <div class="form-group">
        <%= f.label :sale_price_ends_at %>
        <%= f.date_field :sale_price_ends_at %>
      </div>
    </div>
    <div class="form-group">
      <%= f.label :state %>
      <%= f.select :state, Product.states.keys.map { |k| [k.to_s.humanize, k] } %>
    </div>
    <div class="form-group">
      <%= f.label :product_type %>
      <div>
        <div class="mb-2">
          <%= f.radio_button :productable_type, "DigitalProduct", id: "product_digital_product" %>
          <%= f.label :digital_product %>

          <%= f.fields_for :productable do |pf| %>
            <fieldset class="mb-4 mt-4 card">
              <div class="form-group">
                <div class="form-group mb-2">
                  <%= pf.label :sample %>
                  <% if @product.digital_product? && @product.productable&.sample&.attached? %>
                    <small>File sekarang: <%= @product.productable.sample.filename.to_s %></small>
                  <% end %>
                  <%= pf.file_field :sample %>
                </div>

                <%= pf.label :resource_type %>
                <div class="mb-2">
                  <%= pf.radio_button :resource_type, "file", id: "product_productable_file", checked: @product.digital_product? && @product.productable&.file? %>
                  <%= pf.label :file %>

                  <div class="resource">
                    <div class="form-group mt-2">
                      <%= pf.label :resource %>
                      <% if @product.digital_product? && @product.productable&.resource&.attached? %>
                        <small>File sekarang: <%= @product.productable.resource.filename.to_s %></small>
                      <% end %>
                      <%= pf.file_field :resource %>
                    </div>
                  </div>
                </div>
                <div>
                  <%= pf.radio_button :resource_type, "url", id: "product_productable_url", checked: @product.digital_product? && @product.productable&.url? %>
                  <%= pf.label :url %>

                  <div class="resource">
                    <div class="form-group mt-2">
                      <%= pf.label :resource_url %>
                      <%= pf.url_field :resource_url, value: @product.digital_product? ? @product.productable&.resource_url : nil %>
                    </div>
                  </div>
                </div>
              </div>
            </fieldset>
          <% end %>
        </div>
        <div class="mb-4">
          <%= f.radio_button :productable_type, "PhysicalProduct", id: "product_physical_product" %>
          <%= f.label :physical_product %>

          <%= f.fields_for :productable do |pf| %>
            <fieldset class="mb-4 mt-4 card">
              <div class="form-group">
                <%= pf.label :weight, "Weight (grams)" %>
                <%= pf.number_field :weight, min: 1 %>
              </div>
              <div class="form-group check-boxes">
                <%= pf.check_box :requires_shipping %>
                <%= pf.label :requires_shipping %>
              </div>
            </fieldset>
          <% end %>

          <div class="mt-4" data-controller="variants">
            <h3>Variants</h3>
            <div id="variants-container">
              <%= f.fields_for :product_variants do |variant_fields| %>
                <div class="variant-form mb-4" data-variants-target="variant">
                  <div class="form-group">
                    <%= variant_fields.label :name %>
                    <%= variant_fields.text_field :name %>
                  </div>
                  <div class="form-group">
                    <%= variant_fields.label :price %>
                    <%= variant_fields.number_field :price, step: 0.01, min: 0 %>
                  </div>
                  <div class="form-group">
                    <%= variant_fields.label :weight, "Weight (override, grams)" %>
                    <%= variant_fields.number_field :weight, step: 1, min: 0 %>
                  </div>
                  <div class="form-group">
                    <%= variant_fields.label :stock %>
                    <%= variant_fields.number_field :stock, step: 1, min: 0 %>
                  </div>
                  <div class="form-group check-boxes">
                    <%= variant_fields.check_box :is_active %>
                    <%= variant_fields.label :is_active %>
                  </div>
                  <%= variant_fields.hidden_field :_destroy, value: "0", data: { variants_target: "destroyInput" } %>
                  <button type="button" data-action="click->variants#remove" class="button-as-text text-red mt-8 underline">Remove</button>
                </div>
              <% end %>
            </div>
            <div>
              <button type="button" data-action="click->variants#add" class="btn">Add Variant</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%= f.submit "Simpan" %>
  </div>
<% end %>
